---
output:
  word_document: default
  html_document: default
---
# R语言ETL系列：过滤（filter）

本章节介绍如何根据条件对表格进行过滤，主要使用filter函数进行实现。  
首先加载需要的包和数据，我们会用到R语言自带的mtcars数据集。首先我们把行的名称转化为一列数据，名为rownams。然后，把数据库转化为tibble格式，存在mtcars1变量中。

```{r,message=FALSE}
library(tidyverse)

mtcars %>%
  rownames_to_column() %>%
  as_tibble() -> mtcars1

mtcars1
```


## 条件过滤：filter
实际工作中，经常会需要用到把一定条件的记录调出来的情况。比如，如果我是超市的数据分析师，我需要查看单次消费超过500元的购物清单，就需要用到条件过滤。
在我们的例子中，比如我们需要提取cyl为4的记录（cyl代表汽车气缸的数量），就可以这么操作：

```{r}
mtcars1 %>%
  filter(cyl == 4)
```

结果中我们可以看到，气缸数量为4的记录都被我们调出来了。
相关SQL代码如下：
```
<SQL> SELECT *
FROM `mtcars1`
WHERE (`cyl` = 4.0)
```
## 如何定义条件？

什么是条件？很简单，是或不是。比如上面的例子，如果cyl等于4，就符合条件，否则不符合条件。因此只要我们的语句能够返回一个逻辑值（也就是计算机能够读懂的TURE或者FALSE），那么就能够构成一个条件。基本的条件操作符如下所示：

| 操作符 | 说明 | 操作符 | 说明 |
|----|----|----|----|
| == | 等于 | < | 小于 |
| != | 不等于| <= | 小于等于 |
| > | 大于 | is.na() | 是否为缺失值 |
| >= | 大于等于 | | |

下面我们再举一个实际例子，比如我们需要除了4个气缸以外的数据，可以这么写:

```{r}
mtcars1 %>%
  filter(cyl != 4)
```
  
SQL代码如下：
```
<SQL> SELECT *
FROM `mtcars1`
WHERE (`cyl` != 4.0)
```
## 过滤缺失值
现实生产或商务活动中，总会有一些数据采集不到，这时候就会出现缺失值。作分析的时候，如果有缺失值，就无法进行正确计算，比如计算均值的时候，就不容许数据中包含缺失值。如何去除掉缺失值呢？这里我们可以使用drop_na函数。  
下面我们先构造一个3*2的数据框，并在里面设置缺失值。例子如下：

```{r}
df <- tibble(x = c(1, 2, NA), y = c("a", NA, "b"))
df #原始数据框
df %>% drop_na()   #去掉含有缺失值的行
df %>% drop_na(x)  #去掉x列含有缺失值的行
```

我们可以看到，使用drop_na函数，我们可以轻松地去掉包含缺失值的行，而且还可以指定去除某列中含有缺失值的行。那么，我们怎么找到这些具有缺失值的行呢？非常简单，利用is.na函数即可，例子如下：

```{r}
df %>%
  filter(is.na(x))
```

SQL代码如下：
```
<SQL> SELECT *
FROM `df`
WHERE (((`x`) IS NULL))
```
## 组合过滤
如果只有一个条件，也许非常简单。但是条件很多的时候，我们就需要使用逻辑操作符来把条件组合起来，一起进行过滤。经典的逻辑操作符包括&（与）、|（或）、!（非），有的编程语言会用英语AND/OR/NOT来表示这些逻辑关系，但是在逻辑层面上表达是一致的。下面通过一个例子来说明这些逻辑关系：

- &：如果顾客最近一周买了东西且（&）买的东西超过100元，那么我们把这些顾客的交易记录调出来；
- |：如果顾客最近一周买了东西或者（|）购买东西的频率维持在一周一次，那么我们把这些顾客的交易记录调出来；
- !：我们只考虑女性客户，因此男性客户都剔除（!）掉。

上面提到的是做RFM模型的一些业务逻辑，现在我们依据mtcars的数据集来给大家举例。

### &操作符

我们想要筛选气缸（cyl）为4，而且马力（hp）大于100的汽车。

```{r}
mtcars1 %>%
  filter(cyl == 4 & hp > 100)

#等价于
mtcars1 %>%
  filter(cyl == 4,hp > 100)

```
  
SQL代码如下：
```
<SQL> SELECT *
FROM `mtcars1`
WHERE ((`cyl` = 4.0) AND (`hp` > 100.0))
```

### |操作符
我们想要筛选气缸（cyl）为4，或者马力（hp）大于100的汽车。

```{r}
mtcars1 %>%
  filter(cyl == 4 | hp > 100)
```

SQL代码如下：
```
<SQL> SELECT *
FROM `mtcars1`
WHERE (`cyl` = 4.0 OR `hp` > 100.0)
```
### !操作符
我们想要筛选除了4个气缸以外的汽车记录。

```{r}
mtcars1 %>%
  filter(!cyl == 4)

#等价于
mtcars1 %>%
  filter(cyl != 4)
```
  
SQL代码如下：
```
<SQL> SELECT *
FROM `mtcars1`
WHERE (NOT(`cyl` = 4.0))
```

## 文本过滤
数据表中的数据不都是数值型的，有的是字符串格式存在的文本。在我们的例子中，比如我们想了解Merc这个型号的车，那么我们就要从rowname列中个提取包含“Merc”的行。  
R语言tidyverse包中，包含了stringr包，可以对字符串进行识别、替换、提取等高级操作。如果我们要根据字符串进行过滤，就需要用到str_detect函数，例子如下：

```{r}
#提取rowname中包含“Merc”的记录

mtcars1 %>%
  filter(str_detect(rowname,pattern = "Merc"))
```
  
SQL代码为：
```
<SQL> SELECT *
FROM `mtcars1`
WHERE (INSTR('^Merc', `rowname`) > 0)
```

我们看到pattern参数中，我们赋予了“Merc”模式。事实上，pattern可以接受正则表达式的内容，比如我们要搜索以M开头的车型，那么就可以把pattern改为“^M”：

```{r}
mtcars1 %>%
  filter(str_detect(rowname,pattern = "^M"))
```
  
SQL代码为：
```
<SQL> SELECT *
FROM `mtcars1`
WHERE (INSTR('^M', `rowname`) > 0)
```
  
正则表达式是一个很有用的工具，如果能够写出高效的正则表达式，就能够对字符串进行更加高级的筛选。不过正则表达式超出了本系列的范围，因此不进行更多的介绍。

## 小结
本章介绍了如何用filter函数完成过滤，我们了解了如何通过构造条件来对数据表的记录进行筛选。此外，我们能够去掉表格中含有缺失值的数据，还能把这些缺失的记录单独提取出来。最后，我们学会了如何通过构造组合过滤来进行复杂的表格数据筛选，并知道如何利用str_detect函数对文本格式的数据进行筛选。

