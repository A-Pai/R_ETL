
# 综合应用

前面对每个例子的介绍都非常简单，其实数据操作就是这么简单的事情。再复杂的事情，都是能够化为很简单的元素，然后通过简单元素的巧妙堆叠，完成复杂的操作。本章将会利用我们先前学过的知识，对nycflights13包中的数据集做一个简单的探索性分析。当然，分析都是开放的，你可以尽情地探索自己感兴趣的话题，我们的例子只是引导大家来运用先前学过的所有数据预处理操作，从而灵活地在R中操纵数据。

## 准备工作

```{r,message=FALSE}
library(tidyverse)
library(nycflights13)
```

## 数据理解
要对数据做分析之前，应该先了解数据的背景。受限于篇幅，这里不会对flights数据集进行详尽的介绍，但是我们应该知道，它是一份航班数据集，包含航班的日期、起点、重点、起飞、降落时间等，具体请参考帮助文档：
```{r}
?flights
```


## 数据观察
```{r}
flights
```

> 这是一个相对较大的数据集，很可能受限于屏幕大小而无法显示完整数据。如果想要看到所有的列，可以使用flights %>% print(width = Inf)。对行的查询可以用参数n来设定，可以多看一些行，但是不建议使用n = Inf,否则会强制显示所有行，这个数据一共有336,766行。

## 基本操作

我们先来看看这份数据的时间涵盖哪些年份。
```{r}
flights %>% distinct(year)
```
  
我们可以看到只有2013年的数据。那么一共是多少天的数据？

```{r}
flights %>% 
  distinct(year,month,day)
```
  
可以看出来，一共365天的数据，这应该囊括了全年的数据。  
现在，我们想知道这些飞机都飞哪些区间，一共有多少个“起点->终点”的组合：
```{r}
flights %>%
  distinct(origin,dest)
```
  
发现一共有224个区间组合。现在我们想看看以EWR为起点，IAH为终点的航班有多少：

```{r}
flights %>%
  filter(origin == "EWR",dest == "IAH") %>%
  nrow()
```
  
这一点EWR->IAH的飞机一共飞了3973趟。他们都是由哪些航班负责飞行的？哪些公司飞这个会飞多一点？我们做一个降序排列：

```{r}
flights %>%
  filter(origin == "EWR",dest == "IAH") %>%
  count(carrier) %>%
  arrange(desc(n))
```
  
结果发现，只有UA一家公司飞这个路线，我们好奇UA的全称是什么，这时候需要连接到公司的表格中，那个表格名称为airline，继续操作：

```{r}
flights %>%
  filter(origin == "EWR",dest == "IAH") %>%
  count(carrier) %>%
  arrange(desc(n)) %>%
  left_join(airlines)
```
  
在name中我们看到，这个公司的全称是United Air Lines Inc.  

## 分组统计
现在我想要看每天飞了多少个航班：
```{r}
flights %>%
  count(year,month,day)
```
  
每天都不一样，哪天飞最多，哪天飞最少？

```{r}
flights %>%
  count(year,month,day) %>%
  filter(n == max(n) | n == min(n))
```
  
发现11月27号飞最多，1014班，而它的下一天28号则飞得最少，只有634班。  
现在我要把每个月起飞时间延误最长的航班筛选出来，这样我们就要计算时间差，操作如下：

```{r}
flights %>%
  mutate(delay_time = dep_time - sched_dep_time) %>%  #计算延误时间
  group_by(month) %>%    #按照月份分组
  arrange(desc(delay_time)) %>%   #按照延误时间长短，有长到短排序
  slice(1) %>%  #每月取首行
  ungroup()  #取消分组
  
```
  
需要提醒大家的是，为什么这里没有group_by(year,month)？因为year全部都是2013，所以没有必要，事实上我们知道year都是2013的话，完全可以把它去掉。  

## 小结
这个综合应用中，我们按照各种想法，做了不同的分析。在这个过程，我们可以看到，只要能够熟练掌握我们先前在各个章节中的基本操作，任何对数据操纵的想法都可以在表格中迅速实现。关于这份数据集，你有其他的想法来进行探索吗？把它们写下来，然后一个一个利用我们学到的基本操作来实现，你将会得到意想不到的收获！


