
# 分组（group_by）

本章会讲解如何对数据进行分组。首先我们要明确一点，就是为什么要分组，实际应用的场景是什么？  
如果我们现在有一个学校，我们想要分别得到男生和女生的平均身高，就需要分组，也就是根据性别对学生的身高分组，然后分别求平均值。这个例子我们只是分了两组，可能大家还看不到分组的力量。那么，如果我们现在要知道每一个班级数学成绩的平均分，那么我们就要对数据成绩根据班级分组，比如我们一个年级有12个班级，那么就要对12个班级分别计算平均分。当分组的数量越多的时候，如果没有分组的操作，分开来一个一个计算是极其耗时的。所以分组功能在实际工作中，具有非常广泛的应用。  
下面我们围绕分组进行举例分析，这次我们会用到R语言自带的mtcars数据集，首先我们把它转化成tibble形式，然后存放在mtcars1中。准备代码如下：

```{r,message=FALSE}
library(tidyverse)

mtcars %>% as_tibble() -> mtcars1

mtcars1
```

## 分组操作
要在R语言中做分组操作，只需要使用group_by函数即可，在函数中放入想要根据什么分组，也就是分组的列名称。 
下面，我们会根据汽车的气缸数量（cyl）分组，然后取各自前三个记录进行展示：

```{r}
mtcars1 %>%
  group_by(cyl) %>%   #根据cyl进行分组
  slice(1:3)          #取每个分组的1~3个记录
      
```

通过结果我们可以看到，我们把4个气缸、6个气缸和8个气缸的汽车都提取了前面3条记录。 


## 取消分组
需要注意的是，如果我们进行group_by操作之后，整个数据表就处于一种分组的状态，也就是说，所有的操作都是基于分组进行，也就是会分别对组内的数据操作。如果你有n个分组，那么我们会得到n份结果。有的时候我们进行分组运算以后，就需要对数据进行重新分组，或者就可以直接取消分组做其他操作了，那么应该怎么办？这时候应该使用ungroup函数。

```{r}
mtcars1 %>%
  group_by(cyl) %>%   
  slice(1:3) %>%         
  ungroup()   
```
  
比较有ungroup和没有ungroup的结果，大家可以发现，进行取消分组之后，结果中少了“# Groups:   cyl [3]”这一行，也就是说明我们取消分组成功了。

> 建议大家每次使用group_by的时候，总是在进行分组计算或操作之后，马上使用ungroup函数取消分组，在后面需要继续分组的时候再使用group_by。这样做有利于避免混乱，干净利索地完成每一次分组操作而不会出错。事实上目前版本的dplyr中，每次group_by都会覆盖掉之前的分组，也就是如果你在一条语句中出现了两个group_by，那么后面的分组会覆盖掉前面的分组，也就是前面的分组会自动失效。如果你是想要叠加分组，那么可以在group_by函数中进行参数设置，添加“add = T”即可。

## 分组排序
分组本身只是数据组织形式的改变，不会对数据造成任何变化。我们分组的目的，往往是为了在分组之后对各个组别进行相同的处理。下面我们先举一个分组排序的例子，我们想要查看不同气缸数（cyl）的汽车的马力（hp），挑出最高的三款汽车来看。

```{r}
mtcars1 %>%
  group_by(cyl) %>%      #根据cyl分组
  arrange(desc(hp)) %>%  #根据hp做降序排列
  slice(1:3) %>%         #取没组前三个记录
  ungroup()              #取消分组
```


## 分组过滤
下面我们希望挑选不同气缸数的汽车里面，它们马力能够达到150以上的汽车记录，代码如下：

```{r}
mtcars1 %>%
  group_by(cyl) %>%
  filter(hp > 150) %>%
  ungroup()
```
  
我们可以发现，要达到150的马力，是需要很多气缸的。结果中没有4个气缸的汽车，6个气缸的汽车只有一个，其余全部是8个气缸的汽车。


## 分组汇总
现在，我们根据不同的气缸数量，看看不同数量的气缸最高能够达到多少马力。

```{r}
mtcars1 %>%
  group_by(cyl) %>%
  summarise(hp_max = max(hp)) %>%
  ungroup()
```

我们可以看到，4个气缸的汽车最高马力为113，6个为175，而8个气缸则最高可达335。

## 小结
本章我们讲解了如何使用分组来进行数据的查询和计算。事实上我们学习的操作都非常简单，但是如果能够把这些简单的操作有效组合起来，它的效率是会倍增的。利用分组，我们可以对不同的组别同时进行排序、过滤、汇总等运算，从而高效完成任务。需要谨记的是，建议在分组运算完毕之后，及时取消分组，以免在后面的操作中发生混乱。









